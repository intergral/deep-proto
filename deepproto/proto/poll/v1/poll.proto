syntax = "proto3";

package deepproto.proto.poll.v1;

import "deepproto/proto/resource/v1/resource.proto";
import "deepproto/proto/tracepoint/v1/tracepoint.proto";

option java_multiple_files = true;
option java_package = "com.intergral.deep.proto.poll.v1";
option go_package = "github.com/intergral/deep-proto/proto/deep/poll/v1";

message PollRequest {
  int64 ts = 1; //time message was sent, acts as message id (useful for tracing)
  string currentHash = 2; //some id that represents the clients current config, or null if no current config
  deepproto.proto.resource.v1.Resource resource = 3; //this is the attributes that describe the resource requesting a config (e.g. service.name: shop-service)
}

enum ResponseType {
  NO_CHANGE = 0; // This is sent when the 'currentHash' from the request is the same as the response. So the client should do nothing.
  UPDATE = 1; // This is sent when the client should process the response to update the config.
}

message PollResponse {
  int64 ts = 1; //time message was sent, acts as message id (useful for tracing)
  string currentHash = 2; //some id that represents the clients current config, or null if no current config
  repeated deepproto.proto.tracepoint.v1.TracePointConfig response = 3; // this would be the list of dynamic configs that are to be installed. This should be the full set, not a partial or delta. Can be null if the response type is 'no-change'
  ResponseType responseType = 4; // This indicates if the config has changed or not. if 'no-change' then 'response' will be null/empty
}

// This is how the application agent should request the config of the tracepoints.
service PollConfig {
  //Call this function as often as is required to ensure config is up to date.
  rpc poll (PollRequest) returns (PollResponse) {}
}
